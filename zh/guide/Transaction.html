<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>交易(Transaction) | Laksa</title>
    <meta name="description" content="Zilliqa BlockChain Javascript API">
    
    
    <link rel="preload" href="/Laksa-docs/assets/css/0.styles.ad03052c.css" as="style"><link rel="preload" href="/Laksa-docs/assets/js/app.915bd5b2.js" as="script"><link rel="preload" href="/Laksa-docs/assets/js/22.e5fc6571.js" as="script"><link rel="prefetch" href="/Laksa-docs/assets/js/10.51e8c64f.js"><link rel="prefetch" href="/Laksa-docs/assets/js/11.4ccfd63d.js"><link rel="prefetch" href="/Laksa-docs/assets/js/12.7d04d408.js"><link rel="prefetch" href="/Laksa-docs/assets/js/13.9662df95.js"><link rel="prefetch" href="/Laksa-docs/assets/js/14.16296ff8.js"><link rel="prefetch" href="/Laksa-docs/assets/js/15.63c87db7.js"><link rel="prefetch" href="/Laksa-docs/assets/js/16.ee0914f5.js"><link rel="prefetch" href="/Laksa-docs/assets/js/17.ab9cfff9.js"><link rel="prefetch" href="/Laksa-docs/assets/js/18.f2955104.js"><link rel="prefetch" href="/Laksa-docs/assets/js/19.2f9092b8.js"><link rel="prefetch" href="/Laksa-docs/assets/js/20.672ba0ed.js"><link rel="prefetch" href="/Laksa-docs/assets/js/21.a4b1ed18.js"><link rel="prefetch" href="/Laksa-docs/assets/js/23.85e35b31.js"><link rel="prefetch" href="/Laksa-docs/assets/js/3.34058b88.js"><link rel="prefetch" href="/Laksa-docs/assets/js/4.eea39184.js"><link rel="prefetch" href="/Laksa-docs/assets/js/5.c8bc3a65.js"><link rel="prefetch" href="/Laksa-docs/assets/js/6.0f8fa8f3.js"><link rel="prefetch" href="/Laksa-docs/assets/js/7.e889666c.js"><link rel="prefetch" href="/Laksa-docs/assets/js/8.d3a0e380.js"><link rel="prefetch" href="/Laksa-docs/assets/js/9.cdb372bc.js"><link rel="prefetch" href="/Laksa-docs/assets/js/vendors~docsearch.d69e689a.js">
    <link rel="stylesheet" href="/Laksa-docs/assets/css/0.styles.ad03052c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Laksa-docs/zh/" class="home-link router-link-active"><!----> <span class="site-name">Laksa</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Laksa-docs/zh/" class="nav-link">介绍</a></div><div class="nav-item"><a href="/Laksa-docs/zh/guide/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="/Laksa-docs/zh/api/" class="nav-link">API文档</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Laksa-docs/guide/Transaction.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/Laksa-docs/zh/guide/Transaction.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Laksa-docs/zh/" class="nav-link">介绍</a></div><div class="nav-item"><a href="/Laksa-docs/zh/guide/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="/Laksa-docs/zh/api/" class="nav-link">API文档</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Laksa-docs/guide/Transaction.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/Laksa-docs/zh/guide/Transaction.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Laksa-docs/zh/guide/" class="sidebar-link">开始</a></li><li><a href="/Laksa-docs/zh/guide/QuickTutorial.html" class="sidebar-link">快速教程</a></li><li><a href="/Laksa-docs/zh/guide/Transaction.html" class="active sidebar-link">交易(Transaction)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#什么是交易" class="sidebar-link">什么是交易?</a></li><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#应当熟记的交易逻辑" class="sidebar-link">应当熟记的交易逻辑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#_1-构造一个-transaction-对象" class="sidebar-link">1. 构造一个 Transaction 对象</a></li><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#_2-使用帐号进行签名" class="sidebar-link">2. 使用帐号进行签名</a></li><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#_3-发送已签名的-transaction-到区块链" class="sidebar-link">3. 发送已签名的 Transaction 到区块链</a></li><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#_4-确认一笔交易" class="sidebar-link">4. 确认一笔交易</a></li><li class="sidebar-sub-header"><a href="/Laksa-docs/zh/guide/Transaction.html#_5-小结一下" class="sidebar-link">5. 小结一下</a></li></ul></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="交易-transaction"><a href="#交易-transaction" aria-hidden="true" class="header-anchor">#</a> 交易(Transaction)</h1> <h2 id="什么是交易"><a href="#什么是交易" aria-hidden="true" class="header-anchor">#</a> 什么是交易?</h2> <p>交易(Transaction)是每个区块链中的核心逻辑</p> <p>交易在以下场景中会发生:</p> <ol><li>地址与地址间发送 Token.</li> <li>地址于地址间发送消息.</li> <li>部署或者调用智能合约.</li></ol> <p>交易 <strong>不会</strong> 在以下场景发生:</p> <ol><li>帐号的创建和导入</li> <li>使用 RPC 对区块链信息进行查询</li></ol> <h2 id="应当熟记的交易逻辑"><a href="#应当熟记的交易逻辑" aria-hidden="true" class="header-anchor">#</a> 应当熟记的交易逻辑</h2> <p>链上的交易逻辑是复杂的，而每个链的处理方式也不太一样</p> <p>然而在客户端开发的过程中, 交易逻辑的处理基本上大同小异</p> <p>我们最好牢记在心</p> <p>为了更好的更容易的理解, 我们采用发送 Token(<code>Transfer Token</code>) 作为例子进行讲解.</p> <h3 id="_1-构造一个-transaction-对象"><a href="#_1-构造一个-transaction-对象" aria-hidden="true" class="header-anchor">#</a> 1. 构造一个 Transaction 对象</h3> <p>假设 Alice 想给 Bob 转一些 Token, Alice 应当获知的信息如下:</p> <ol><li><code>toAddr</code>, Bob 的地址</li> <li><code>amount</code>, Bob 想收到的 Token 数量,这里我们假设是 1000 个 Zil</li> <li><code>gasLimit</code>, 交易所消耗的最大 Gas 值, 根据 Zilliqa 的设定, gasLimit 这里需要采用 Long 的数据类型</li> <li><code>gasPrice</code>, 交易所支付给矿工的 Gas 的单笔价值,根据 Zilliqa 的设定, gasPrice 最小值应为 100, 而我们只发送 BN 的数据类型</li> <li><code>version</code>, 协议的版本号, 这里我们设置为默认的 0</li></ol> <p>然后你就可以使用 <code>laksa.transactions</code> 来构造一个 Transaction 对象了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/*
    设置toAddr为Bob的地址
    设置amount为1000
    设置gasPrice为默认的100
    设置gasLimit为例子中的1000
    设置version为默认的0
*/</span>

<span class="token keyword">const</span> transaction <span class="token operator">=</span> laksa<span class="token punctuation">.</span>transactions<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  toAddr<span class="token punctuation">:</span> <span class="token string">'9bfec715a6bd658fcb62b0f8cc9bfa2ade71434a'</span><span class="token punctuation">,</span>
  amount<span class="token punctuation">:</span> laksa<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">toBN</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  gasPrice<span class="token punctuation">:</span> laksa<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">toBN</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  gasLimit<span class="token punctuation">:</span> laska<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Long<span class="token punctuation">.</span><span class="token function">fromNumber</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  version<span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-使用帐号进行签名"><a href="#_2-使用帐号进行签名" aria-hidden="true" class="header-anchor">#</a> 2. 使用帐号进行签名</h3> <p>做完了上一步，Transaction 对象构造完毕了，但是我们还不能直接向区块链进行发送</p> <p>就像你使用支票进行支付，必须要签上自己的名字一样。</p> <p>每一个 Transaction 都要进行签名，而你应该使用帐号进行处理。</p> <p>首先确保你已经有了一个帐号，导入到 Wallet 或者 Account 对象</p> <p>然后就使用<code>signTransaction</code>方法进行签名</p> <p>而请记住，<code>signTransaction</code>方法会返回一个<code>Promise</code>， 因为这个方法的内在逻辑会向区块链请求更新帐号的余额和 nonce 数</p> <p>而如果你的帐号是加密状态的，请提供密码作为第二个参数传入方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 假设你使用wallet导入一个账号</span>
<span class="token comment">// 这个myAccount将包含访问区块链的内置方法</span>

<span class="token keyword">const</span> myAccount <span class="token operator">=</span> laksa<span class="token punctuation">.</span>wallet<span class="token punctuation">.</span><span class="token function">importAccountFromPrivateKey</span><span class="token punctuation">(</span><span class="token constant">YOUR_KEY</span><span class="token punctuation">)</span>

<span class="token comment">// 你也可以使用 `new laksa.Modules.Account()` 去构造一个帐号,</span>
<span class="token comment">// 不过你必须手动构造 Messenger 和 Provider ，才能确保Account包含当前的区块链信息</span>

myAccount<span class="token punctuation">.</span><span class="token function">signTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>signed <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>signed<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 如果你的帐号加密了，请把密码作为字符串传入第二个参数</span>
<span class="token comment">// myAccount.signTransaction(transaction,password)</span>
<span class="token comment">// 完成了加密过程，打印的结果中你可以看到signature这个属性下面有个长长的字符串</span>
</code></pre></div><h3 id="_3-发送已签名的-transaction-到区块链"><a href="#_3-发送已签名的-transaction-到区块链" aria-hidden="true" class="header-anchor">#</a> 3. 发送已签名的 Transaction 到区块链</h3> <p>完成了签名之后，你就可以发送到区块链了</p> <p>这里至少有两种途径发送到区块链</p> <p>使用 <code>Transaction.sendTransaction()</code> ，在这之后，将返回 Transaction 对象，你可以继续对它进行操作.
使用 <code>laksa.zil.createTransaction(SignedTransaction)</code> ，你可以把签名后的 Transaction 作为参数传入.</p> <p>然而两种方法有着不一样的输出
第一种, <code>Transaction</code> 会作为结果的一部分进行返回, 而你可以使用<code>then</code> 对它进行进一步的操作.
第二种, 将只会返回 RPC Response,你必须使用其他方法再对 Transaction 进行操作了.</p> <p>我们将使用第一种方法来继续我们的教程</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>myAccount
  <span class="token punctuation">.</span><span class="token function">signTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>signed <span class="token operator">=&gt;</span> signed<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sent <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sent<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * 你会看到一个返回的对象
  {transaction:&lt;Object:Transaction&gt;,response:Response}
 */</span>
</code></pre></div><h3 id="_4-确认一笔交易"><a href="#_4-确认一笔交易" aria-hidden="true" class="header-anchor">#</a> 4. 确认一笔交易</h3> <p>在 Transaction 发送的时候，<code>laksa</code> 会使用 RPC call.</p> <p>而 RPC call 会返回一个 Response，如果没有发生错误的情况下，一个包含<code>TranID</code>的 Response 对象将会返回，而<code>TranID</code>将作为交易的查询单号</p> <p>然而，并不是每一步交易都最终被区块链所接受，如果</p> <ol><li>你的交易参数不对，比如 gasLimit/gasPrice 并不符合当前的交易规则.</li> <li>你的帐号余额不足, <code>laksa</code> 不会自动帮你检查, 对于应用开发者,请记得检查并告知用户.</li> <li>区块链发生了<code>拥堵</code> , 又或者有一些不可知的错误发生(真实情况是很复杂的)</li></ol> <p>因此，我们需要在交易发送之后，进行确认</p> <p>在上一步中, 我们收到了像这样的对象:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
   transaction<span class="token punctuation">:</span><span class="token operator">&lt;</span>Object<span class="token punctuation">:</span>Transaction<span class="token operator">&gt;</span><span class="token punctuation">,</span>
   response<span class="token punctuation">:</span><span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你可以看到<code>transaction</code> 就是 Transaction 对象本身，而这里已经更新了发送的状态, 我们可以结合<code>response</code>中的内容进行进一步处理</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 使用transaction.confirm，并将TranID作为参数传入
 * 这个方法将进行RPC Call，并定时请求查询交易单
 */</span>

myAccount
  <span class="token punctuation">.</span><span class="token function">signTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>signed <span class="token operator">=&gt;</span> signed<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>response<span class="token punctuation">.</span>TranID<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>

<span class="token comment">/**
 * 当交易单被确认或者拒绝，你会收到一个回执
 */</span>
</code></pre></div><p>如果 Transaction 被区块链所接受, 你会获得<code>Transaction.receipt</code>，包含一个这样的对象：<code>{cumulative_gas:string,success:boolean}</code></p> <p>当中， <code>cumulative_gas</code> 表示了实际消耗的 Gas 费用.</p> <p>而<code>success</code> 中的 true 或者 false 将表示该交易是否成功完成，即刚才的 1000 Zil 有没有成功到达</p> <p>如果 Transaction 被<code>confirm</code>所确认，返回的 <code>status</code> Transaction 对象随之改变.</p> <p>包含 <code>REJECTED</code> 或者 <code>SUCCESS</code>，这里<code>REJECTED</code>对应着<code>success:false</code>，而<code>SUCCESS</code>显然对应着<code>success:true</code></p> <p>如果 Transaction 发送了，而没有被最终区块链所接受，则<code>SENT</code>的状态将维持不变。</p> <h3 id="_5-小结一下"><a href="#_5-小结一下" aria-hidden="true" class="header-anchor">#</a> 5. 小结一下</h3> <p>整个交易过程并不难理解，它总是依照以下顺序发生:</p> <ol><li><p><strong>构造</strong></p> <p>使用 <code>laksa.transactions.new</code> 初始化，构造交易对象</p> <p>Transaction Status:Initialized</p></li> <li><p><strong>签名</strong></p> <p>使用 <code>account.signTransaction</code> 进行签名, 传入签名所指定的 account 和 password（如果必要的话）
Transaction Status:Signed</p></li> <li><p><strong>发送</strong></p> <p>使用 <code>Transaction.send</code> 发送, 如果正常，则会返回 {transaction:Transaction,response:Response}</p> <p>Transaction Status:Sent</p></li> <li><p><strong>确认</strong></p> <p>使用 <code>Transaction.confirm</code> 进行确认, 使用<code>TranID</code>作为参数, 如果交易单被区块链所接受, 回执(receipt)将会返回</p> <p>Transaction Status:Success / Rejected</p></li></ol></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Laksa-docs/zh/guide/QuickTutorial.html" class="prev">
          快速教程
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/Laksa-docs/assets/js/app.915bd5b2.js" defer></script><script src="/Laksa-docs/assets/js/22.e5fc6571.js" defer></script>
  </body>
</html>
